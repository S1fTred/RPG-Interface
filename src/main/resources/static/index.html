<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Tabletop RPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- –í–ê–ñ–ù–û: –æ–¥–∏–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π CSS -->
    <link rel="stylesheet" href="/styles.css" />
    <style>.hidden{display:none}</style>
</head>

<body>
<header class="topbar">
    <div class="brand">üíÄ Tabletop RPG</div>
    <nav id="top-nav">
        <button class="btn" id="btnLoginNav">–í–æ–π—Ç–∏</button>
        <button class="btn" id="btnRegisterNav">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="btn ghost hidden" id="btnLogoutNav">‚Ü™Ô∏é –í—ã–π—Ç–∏</button>
    </nav>
</header>

<!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
<nav id="main-nav" class="nav hidden" style="margin: 0 1rem;">
    <button class="btn link" data-goto="#view-home">Home</button>
    <button class="btn link" data-goto="#view-campaigns">–ö–∞–º–ø–∞–Ω–∏–∏</button>
    <button class="btn link" data-goto="#view-characters">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
    <button class="btn link" data-goto="#view-journals">–ñ—É—Ä–Ω–∞–ª—ã</button>
    <button class="btn link admin-only" data-goto="#view-items">–ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</button>
</nav>

<main class="container">

    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <section id="view-welcome" class="view">
        <div class="card">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.</p>
        </div>
    </section>

    <!-- –í—Ö–æ–¥ -->
    <section id="view-login" class="view hidden">
        <form id="loginForm" class="card" autocomplete="on">
            <h2>–í—Ö–æ–¥</h2>
            <div id="loginError" class="form-error hidden"></div>
            <input id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
            <input id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
            <div class="row">
                <button id="loginSubmit" type="button" class="btn primary">–í–æ–π—Ç–∏</button>
                <button id="goRegister" type="button" class="btn ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
        </form>
    </section>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <section id="view-register" class="view hidden">
        <form id="registerForm" class="card" autocomplete="off">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div id="registerError" class="form-error hidden"></div>
            <input id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
            <input id="regEmail" placeholder="Email" type="email" />
            <input id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
            <div class="row">
                <button id="registerSubmit" type="button" class="btn primary">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <button id="goLoginFromRegister" type="button" class="btn ghost">
                    –£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
            </div>
        </form>
    </section>

    <!-- –î–æ–º–æ–π (–ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
    <section id="view-home" class="view hidden">
        <div class="card">
            <h2>–í—ã –≤–æ—à–ª–∏</h2>
            <p>–ù–∏–∂–µ ‚Äî –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ: –∫–∞–º–ø–∞–Ω–∏–∏ (–∫–∞–∫ GM) –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏.</p>
        </div>

        <div class="card">
            <h3>–ú–æ–∏ –∫–∞–º–ø–∞–Ω–∏–∏</h3>
            <div id="home-campaigns-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="card">
            <h3>–ú–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
            <div id="home-characters-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </section>

    <!-- –ö–ê–ú–ü–ê–ù–ò–ò -->
    <section id="view-campaigns" class="view hidden">
        <div class="card row" style="justify-content: space-between; align-items: center;">
            <h2>–ö–∞–º–ø–∞–Ω–∏–∏ (—è ‚Äî GM)</h2>
            <form id="form-create-campaign" class="inline-form">
                <input name="name" placeholder="–ù–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è..." required />
                <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
        <div id="campaigns-list" class="cards"></div>
    </section>

    <!-- –û–î–ù–ê –ö–ê–ú–ü–ê–ù–ò–Ø (–¥–µ—Ç–∞–ª—å–Ω–∞—è) -->
    <section id="view-campaign" class="view hidden" data-campaign-id="">
        <div class="card">
            <button class="btn link" id="btn-back-to-campaigns">‚Üê –ù–∞–∑–∞–¥</button>
            <h2 id="campaign-title" style="margin-top:.5rem;">–ö–∞–º–ø–∞–Ω–∏—è</h2>
        </div>

        <div class="grid-2">
            <div class="card">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <form id="form-add-member" class="inline-form">
                    <input name="userId" type="number" placeholder="User ID" required />
                    <select name="roleInCampaign">
                        <option value="PLAYER">PLAYER</option>
                    </select>
                    <button class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
                <div id="members-list" class="list mt-s"></div>
            </div>

            <div class="card">
                <h3>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
                <form id="form-create-character" class="stack small">
                    <input name="name" placeholder="–ò–º—è" required />
                    <input name="clazz" placeholder="–ö–ª–∞—Å—Å" required />
                    <input name="race" placeholder="–†–∞—Å–∞" required />
                    <input name="level" type="number" min="1" value="1" required />
                    <input name="maxHp" type="number" min="1" value="10" required />
                    <input name="hp" type="number" min="0" value="10" required />
                    <fieldset class="attrs">
                        <legend>Attributes</legend>
                        <input name="strength" type="number" placeholder="STR" value="10" />
                        <input name="dexterity" type="number" placeholder="DEX" value="10" />
                        <input name="constitution" type="number" placeholder="CON" value="10" />
                        <input name="intelligence" type="number" placeholder="INT" value="10" />
                        <input name="wisdom" type="number" placeholder="WIS" value="10" />
                        <input name="charisma" type="number" placeholder="CHA" value="10" />
                    </fieldset>
                    <button class="btn">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                </form>
                <div id="campaign-characters" class="cards mt-s"></div>
            </div>
        </div>

        <div class="card mt-l">
            <h3>–ñ—É—Ä–Ω–∞–ª—ã</h3>
            <div class="row" style="gap:1rem; align-items:center;">
                <form id="form-create-journal" class="stack small" style="flex:1;">
                    <input name="type" placeholder="–¢–∏–ø" required />
                    <select name="visibility">
                        <option value="PLAYERS">PLAYERS</option>
                        <option value="GM_ONLY">GM_ONLY</option>
                    </select>
                    <input name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü.)" />
                    <textarea name="content" placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ" required></textarea>
                    <input name="tags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
                    <button class="btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </form>
                <div class="right">
                    <label>–§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞: <input id="filter-journal-type" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, session" /></label>
                    <label class="ml"><input type="checkbox" id="chk-include-all" /> include=all (—è ‚Äî GM)</label>
                    <button id="btn-reload-journals" class="btn ml">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
            <div id="journal-list" class="list mt-s"></div>
        </div>
    </section>

    <!-- –ü–ï–†–°–û–ù–ê–ñ–ò (–º–æ–∏, legacy by-owner) -->
    <section id="view-characters" class="view hidden">
        <div class="card"><h2>–ú–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</h2></div>
        <div id="my-characters" class="cards"></div>
    </section>

    <!-- –ü–ï–†–°–û–ù–ê–ñ (–¥–µ—Ç–∞–ª—å–Ω–∞—è) -->
    <section id="view-character" class="view hidden" data-character-id="">
        <div class="card">
            <button class="btn link" id="btn-back-to-characters">‚Üê –ù–∞–∑–∞–¥</button>
            <h2 id="char-name" style="margin-top:.5rem;">–ü–µ—Ä—Å–æ–Ω–∞–∂</h2>
        </div>
        <div class="grid-2">
            <div class="card">
                <dl class="kv">
                    <dt>–ö–ª–∞—Å—Å</dt><dd id="char-class"></dd>
                    <dt>–†–∞—Å–∞</dt><dd id="char-race"></dd>
                    <dt>–£—Ä–æ–≤–µ–Ω—å</dt><dd id="char-level"></dd>
                    <dt>HP</dt><dd><span id="char-hp"></span> / <span id="char-maxHp"></span></dd>
                </dl>
                <form id="form-patch-hp" class="inline-form">
                    <input name="delta" type="number" placeholder="Œî HP" />
                    <input name="set" type="number" placeholder="Set HP" />
                    <button class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </form>
            </div>
            <div class="card">
                <h3>–ê—Ç—Ä–∏–±—É—Ç—ã</h3>
                <div id="char-attrs" class="attrs-read"></div>
                <details class="mt-s">
                    <summary>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</summary>
                    <form id="form-update-character" class="stack small">
                        <input name="name" placeholder="–ò–º—è" />
                        <input name="clazz" placeholder="–ö–ª–∞—Å—Å" />
                        <input name="race" placeholder="–†–∞—Å–∞" />
                        <input name="level" type="number" min="1" />
                        <input name="maxHp" type="number" min="1" />
                        <button class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </details>
            </div>
        </div>
        <div class="card mt-l">
            <button id="btn-delete-character" class="btn danger">–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        </div>
    </section>

    <!-- –ñ–£–†–ù–ê–õ–´ (standalone) -->
    <section id="view-journals" class="view hidden">
        <div class="card">
            <h2>–ñ—É—Ä–Ω–∞–ª—ã –ø–æ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
            <form id="form-journals-pick" class="inline-form">
                <input name="campaignId" type="number" placeholder="campaignId" required />
                <input name="type" placeholder="type (–æ–ø—Ü.)" />
                <label class="ml"><input type="checkbox" name="includeAll" /> include=all</label>
                <button class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </form>
        </div>
        <div id="journals-standalone" class="list mt-s"></div>
    </section>

    <!-- –ü–†–ï–î–ú–ï–¢–´ (ADMIN) -->
    <section id="view-items" class="view hidden">
        <div class="card">
            <h2>–ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (ADMIN)</h2>
            <form id="form-create-item" class="inline-form">
                <input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
                <input name="rarity" placeholder="–†–µ–¥–∫–æ—Å—Ç—å" />
                <button class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
        <div id="items-list" class="list mt-s"></div>
    </section>

</main>

<footer class="footer">¬© Tabletop RPG Interface</footer>

<!-- –ú–æ–¥—É–ª–∏ —Ñ—Ä–æ–Ω—Ç–∞ -->
<script type="module">
    import { login, register, me, signout, boot } from '/js/auth.js';
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏/–ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –≤ Home
    import { loadHomeData } from '/js/app.js';

    // –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏ —ç–∫—Ä–∞–Ω–æ–≤ (—Å–º. —Ñ–∞–π–ª—ã –∏–∑ –∫–∞–Ω–≤–∞—Å–∞)
    import { initCampaignsView } from '/js/campaigns.js';
    import { initCharactersView } from '/js/characters.js';
    import { initJournalsStandalone } from '/js/journals.js';
    import { initItemsView } from '/js/items.js';

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π show –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
    window.show = function(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.querySelector(id)?.classList.remove('hidden');
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏/—Ä–æ–ª–µ–π
    function gateRoles() {
        const user = me();
        const isAdmin = !!user && Array.isArray(user.roles) && user.roles.includes('ROLE_ADMIN');
        document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
    }

    // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π auth-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏ + –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–µ–Ω—é
    function syncNav() {
        const logged = !!me();
        document.getElementById('btnLoginNav').classList.toggle('hidden', logged);
        document.getElementById('btnRegisterNav').classList.toggle('hidden', logged);
        document.getElementById('btnLogoutNav').classList.toggle('hidden', !logged);
        document.getElementById('main-nav').classList.toggle('hidden', !logged);
        if (logged) gateRoles();
    }

    // –ü–µ—Ä–µ—Ö–æ–¥—ã –∏–∑ —à–∞–ø–∫–∏
    document.getElementById('btnLoginNav').onclick = () => show('#view-login');
    document.getElementById('btnRegisterNav').onclick = () => show('#view-register');
    document.getElementById('btnLogoutNav').onclick = () => {
        signout();
        syncNav();
        show('#view-welcome');
    };

    // –°—Å—ã–ª–∫–∏ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏
    document.getElementById('goRegister').onclick = () => show('#view-register');
    document.getElementById('goLoginFromRegister').onclick = () => show('#view-login');

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    document.querySelectorAll('#main-nav [data-goto]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const to = btn.getAttribute('data-goto');
            show(to);
            // –ª–µ–Ω–∏–≤—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤
            if (to === '#view-campaigns') initCampaignsView();
            if (to === '#view-characters') initCharactersView();
            if (to === '#view-journals') initJournalsStandalone();
            if (to === '#view-items') initItemsView();
        });
    });

    // –í—Ö–æ–¥
    document.getElementById('loginSubmit').onclick = async () => {
        const u = document.getElementById('loginUsername').value.trim();
        const p = document.getElementById('loginPassword').value.trim();
        const errBox = document.getElementById('loginError');
        errBox.classList.add('hidden');
        try {
            await login(u, p);
            syncNav();
            show('#view-home');
            try { await loadHomeData(); } catch {}
        } catch (e) {
            errBox.textContent = e?.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
            errBox.classList.remove('hidden');
        }
    };

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('registerSubmit').onclick = async () => {
        const u = document.getElementById('regUsername').value.trim();
        const e = document.getElementById('regEmail').value.trim();
        const p = document.getElementById('regPassword').value.trim();
        const errBox = document.getElementById('registerError');
        errBox.classList.add('hidden');
        try {
            await register(u, e, p); // –≤–Ω—É—Ç—Ä–∏ —Å—Ä–∞–∑—É –ª–æ–≥–∏–Ω
            syncNav();
            show('#view-home');
            try { await loadHomeData(); } catch {}
        } catch (er) {
            errBox.textContent = er?.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            errBox.classList.remove('hidden');
        }
    };

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    await boot();
    syncNav();
    if (me()) {
        show('#view-home');
        try { await loadHomeData(); } catch {}
    } else {
        show('#view-welcome');
    }
</script>

<!-- –í–∞–∂–Ω–æ: —Ñ–∞–π–ª—ã –º–æ–¥—É–ª–µ–π –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ /js/, —Å–º. –∫–∞–Ω–≤–∞—Å -->
<!-- /js/ui.js –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è index.html –Ω–∞–ø—Ä—è–º—É—é, —Ç.–∫. –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª–µ–π -->

</body>
</html>
